import { describe, expect, it } from 'vitest'
import { calculateChildPosition, type Dimension, type Offset } from './index.ts'

const viewportRect: Dimension = { width: 80, height: 20 }
const buttonRect: Offset & Dimension = {
  top: 10,
  left: 38,
  width: 4,
  height: 2,
}
const moveTo = (left: number, top: number) => (rect) => ({ ...rect, top, left })
const moveBy = (dx: number, dy: number) => (rect) => ({
  ...rect,
  top: rect.top + dy,
  left: rect.left + dx,
})

describe('strategies', () => {
  const testStrategy = (strategyName, expectedResult) => {
    const menuRect = { width: 12, height: 6 }
    it(`${strategyName}`, () => {
      const args: Parameters<typeof calculateChildPosition> = [
        strategyName,
        buttonRect,
        menuRect,
        viewportRect,
        { gap: 1 },
      ]
      assertVisual(args, expectedResult)
    })
  }

  testStrategy(
    'bottom left',
    `
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------@@@@--------------------------------------
--------------------------------------@@@@--------------------------------------
--------------------------------------------------------------------------------
--------------------------------------############------------------------------
--------------------------------------############------------------------------
--------------------------------------############------------------------------
--------------------------------------############------------------------------
--------------------------------------############------------------------------
--------------------------------------############------------------------------
--------------------------------------------------------------------------------
`
  )

  testStrategy(
    'bottom center',
    `
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------@@@@--------------------------------------
--------------------------------------@@@@--------------------------------------
--------------------------------------------------------------------------------
----------------------------------############----------------------------------
----------------------------------############----------------------------------
----------------------------------############----------------------------------
----------------------------------############----------------------------------
----------------------------------############----------------------------------
----------------------------------############----------------------------------
--------------------------------------------------------------------------------
`
  )

  testStrategy(
    'bottom right',
    `
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------@@@@--------------------------------------
--------------------------------------@@@@--------------------------------------
--------------------------------------------------------------------------------
------------------------------############--------------------------------------
------------------------------############--------------------------------------
------------------------------############--------------------------------------
------------------------------############--------------------------------------
------------------------------############--------------------------------------
------------------------------############--------------------------------------
--------------------------------------------------------------------------------
`
  )

  testStrategy(
    'left top',
    `
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
-------------------------############-@@@@--------------------------------------
-------------------------############-@@@@--------------------------------------
-------------------------############-------------------------------------------
-------------------------############-------------------------------------------
-------------------------############-------------------------------------------
-------------------------############-------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
`
  )

  testStrategy(
    'right bottom',
    `
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
-------------------------------------------############-------------------------
-------------------------------------------############-------------------------
-------------------------------------------############-------------------------
-------------------------------------------############-------------------------
--------------------------------------@@@@-############-------------------------
--------------------------------------@@@@-############-------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
`
  )

  testStrategy(
    'right center',
    `
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
-------------------------------------------############-------------------------
-------------------------------------------############-------------------------
--------------------------------------@@@@-############-------------------------
--------------------------------------@@@@-############-------------------------
-------------------------------------------############-------------------------
-------------------------------------------############-------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
`
  )
})

describe('primary axis', () => {
  const menuRect = { width: 12, height: 10 }

  it('bounces to the other direction on overflow', () => {
    assertVisual(
      [
        'bottom left',
        moveBy(0, 5)(buttonRect),
        menuRect,
        viewportRect,
        { gap: 1 },
      ],
      // Despite the "bottom left" strategy,
      // there is not enough space at the bottom.
      // Therefore, the menu gets bounced to the top.
      `
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------############------------------------------
--------------------------------------############------------------------------
--------------------------------------############------------------------------
--------------------------------------############------------------------------
--------------------------------------############------------------------------
--------------------------------------############------------------------------
--------------------------------------############------------------------------
--------------------------------------############------------------------------
--------------------------------------############------------------------------
--------------------------------------############------------------------------
--------------------------------------------------------------------------------
--------------------------------------@@@@--------------------------------------
--------------------------------------@@@@--------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
`
    )
  })
  it('tries to keep menu fully on-screen', () => {
    assertVisual(
      ['bottom left', buttonRect, menuRect, viewportRect, { gap: 1 }],
      // Even though gap 1 is requested, but it would push the menu above the viewport.
      `
--------------------------------------############------------------------------
--------------------------------------############------------------------------
--------------------------------------############------------------------------
--------------------------------------############------------------------------
--------------------------------------############------------------------------
--------------------------------------############------------------------------
--------------------------------------############------------------------------
--------------------------------------############------------------------------
--------------------------------------############------------------------------
--------------------------------------############------------------------------
--------------------------------------@@@@--------------------------------------
--------------------------------------@@@@--------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
`
    )
  })
  it('tries switching axis to minimize overlapping', () => {
    const largerMenuRect = { width: 12, height: 12 }
    assertVisual(
      ['bottom left', buttonRect, largerMenuRect, viewportRect, { gap: 1 }],
      // Even though gap 1 is requested, but it would push the menu above the viewport.
      `
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
-------------------------------------------############-------------------------
-------------------------------------------############-------------------------
-------------------------------------------############-------------------------
-------------------------------------------############-------------------------
-------------------------------------------############-------------------------
--------------------------------------@@@@-############-------------------------
--------------------------------------@@@@-############-------------------------
-------------------------------------------############-------------------------
-------------------------------------------############-------------------------
-------------------------------------------############-------------------------
-------------------------------------------############-------------------------
-------------------------------------------############-------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
`
    )
  })
})

describe('secondary axis', () => {
  const menuRect = { width: 40, height: 5 }

  it('works normally when thereâ€™s no overflowing', () => {
    assertVisual(
      ['bottom', buttonRect, menuRect, viewportRect],
      `
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------@@@@--------------------------------------
--------------------------------------@@@@--------------------------------------
--------------------########################################--------------------
--------------------########################################--------------------
--------------------########################################--------------------
--------------------########################################--------------------
--------------------########################################--------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
`
    )
  })
  it('aligns the right edge, when there is not enough space to the right', () => {
    assertVisual(
      ['bottom', moveBy(30, 0)(buttonRect), menuRect, viewportRect],
      `
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------@@@@--------
--------------------------------------------------------------------@@@@--------
--------------------------------########################################--------
--------------------------------########################################--------
--------------------------------########################################--------
--------------------------------########################################--------
--------------------------------########################################--------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
`
    )
  })
  it('aligns the left edge, when there is not enough space to the left', () => {
    assertVisual(
      ['bottom', moveBy(-30, 0)(buttonRect), menuRect, viewportRect],
      `
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------@@@@--------------------------------------------------------------------
--------@@@@--------------------------------------------------------------------
--------########################################--------------------------------
--------########################################--------------------------------
--------########################################--------------------------------
--------########################################--------------------------------
--------########################################--------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
`
    )
  })
  it('center-aligns if there is not enough space when right-aligned', () => {
    assertVisual(
      ['bottom right', moveBy(-16, 0)(buttonRect), menuRect, viewportRect],
      `
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
----------------------@@@@------------------------------------------------------
----------------------@@@@------------------------------------------------------
----########################################------------------------------------
----########################################------------------------------------
----########################################------------------------------------
----########################################------------------------------------
----########################################------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
`
    )
  })
  it('center-aligns if there is not enough space when left-aligned', () => {
    assertVisual(
      ['bottom left', moveBy(16, 0)(buttonRect), menuRect, viewportRect],
      `
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
------------------------------------------------------@@@@----------------------
------------------------------------------------------@@@@----------------------
------------------------------------########################################----
------------------------------------########################################----
------------------------------------########################################----
------------------------------------########################################----
------------------------------------########################################----
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
`
    )
  })
  it('left-aligns if there is not enough space when right-aligned and center-aligning would still cause an overflow', () => {
    assertVisual(
      ['bottom right', moveBy(-24, 0)(buttonRect), menuRect, viewportRect],
      `
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------@@@@--------------------------------------------------------------
--------------@@@@--------------------------------------------------------------
--------------########################################--------------------------
--------------########################################--------------------------
--------------########################################--------------------------
--------------########################################--------------------------
--------------########################################--------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
`
    )
  })
  it('right-aligns if there is not enough space when left-aligned and center-aligning would still cause an overflow', () => {
    assertVisual(
      ['bottom left', moveBy(24, 0)(buttonRect), menuRect, viewportRect],
      `
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------@@@@--------------
--------------------------------------------------------------@@@@--------------
--------------------------########################################--------------
--------------------------########################################--------------
--------------------------########################################--------------
--------------------------########################################--------------
--------------------------########################################--------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
`
    )
  })
})

function assertVisual(
  args: Parameters<typeof calculateChildPosition>,
  expectedResult: string
): void {
  const [, parentRect, childDimension, viewportDimension, ,] = args
  const childPosition = calculateChildPosition(...args)
  let output = '\n'
  for (let i = 0; i < viewportDimension.height; i++) {
    for (let j = 0; j < viewportDimension.width; j++) {
      const inParent =
        parentRect.top <= i &&
        i < parentRect.top + parentRect.height &&
        parentRect.left <= j &&
        j < parentRect.left + parentRect.width
      const inChild =
        childPosition.top <= i &&
        i < childPosition.top + childDimension.height &&
        childPosition.left <= j &&
        j < childPosition.left + childDimension.width
      output += inParent ? '@' : inChild ? '#' : '-'
    }
    output += '\n'
  }
  expect(output).toBe(expectedResult)
}
